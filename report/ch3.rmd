---
title: "Section 3 TB prevention and screening"
author: "Hazim Timimi"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) {
      out_dir <- "./local";
      rmarkdown::render(inputFile,
                        encoding=encoding,
                        output_dir=file.path(dirname(inputFile), out_dir))})
output: 
  html_fragment:
    # Don’t include a table of contents
    toc: no
    # Set standard figure width to 12 inches
    fig_width: 12
    # Don’t write figure captions
    fig_caption: FALSE
    # Don't embed external resources (stylesheets, JS libraries) in the output 
    self_contained: FALSE
    # Don't include <div> tags around a header and the content found until the next header
    section_divs: FALSE  


# To run this file and store output as html:
# rmarkdown::render(here::here("report/ch3.rmd"), output_file = "ch3.html", output_dir = here::here("report/local/"))
---

```{r setup, include=FALSE}
# Set chunk options.
# Results "asis" is useful to output markdown from a function
# Suppress messages, warnings and also the ## at the beginning of printed text

knitr::opts_chunk$set(echo = FALSE, 
                      results = "asis",
                      message = FALSE,
                      warning = FALSE,
                      error = TRUE)  # TEMP error=TRUE for debugging!

# Kill any attempt at using factors, unless we explicitly want them!
options(stringsAsFactors=FALSE)


# Set output options ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

# Show static chart in addition to Kendo chart?
show_static = FALSE

# Save underlying data files as CSV and charts as PDF files?
pdf_csv_folder = here::here("report/local/figures/ch3")
save_csv = TRUE
save_pdf = TRUE

# Create the output folder (only if it doesn't yet exist)
dir.create(pdf_csv_folder, showWarnings = FALSE, recursive = TRUE)


# Load output packages ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
library(ggplot2)
library(dplyr)
library(scales)
library(RColorBrewer)
library(whomap)
library(gtbreport)
library(here)
library(stringr)
library(jsonlite)


# Load R functions ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

source(here("report/functions/html_links.R"))
source(here("report/functions/output_ggplot.R"))


# Get the data sets and computed values/statistics for this chapter ----
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
source(here('report/ch3_prepare_data.r'))

```

```{r css_js}
# Add standard stylesheets and javascript to support kendo
cat(writeLines(readLines(here("report/resources/headers.htm"))))
```







# 3. Tuberculosis prevention and screening


_Draft! Prepared `r Sys.Date()` using country-reported data snapshot files from `r snapshot_date` _


Preventing tuberculosis (TB) infection and stopping progression from infection to disease are critical for reducing TB incidence to the levels envisaged by the End TB Strategy (`r ref_lnk("1")`, `r ref_lnk("2")`). The main health care intervention to stop progression from infection to disease is TB preventive treatment (TPT), which the World Health Organization (WHO) recommends for people living with HIV, household contacts of people with TB and other risk groups (`r ref_lnk("3")`, `r ref_lnk("4")`). Strategies to provide TPT are often linked to screening to find and treat people with TB earlier in the course of their disease and thus help to reduce transmission and improve outcomes (`r ref_lnk("4")`). Other TB preventive approaches are TB infection prevention and control (`r ref_lnk("5")`) and vaccination of children with the bacille Calmette-Guérin (BCG) vaccine. Addressing broader determinants that influence TB epidemics can also help to prevent TB infection and disease; these are discussed in <span class="red">Section 5.3</span>.


## 3.1 TB preventive treatment

The global number of people living with HIV and household contacts of people diagnosed with TB who were provided with TPT increased from `r ftb(f3.1_txt$tot_tpt_2015/1e6)` million in 2015 to `r ftb(f3.1_txt$tot_tpt_2019/1e6)` million in 2019. There was then a sizeable reduction to `r ftb(f3.1_txt$tot_tpt_2020/1e6)` million in 2020 and 2021, probably reflecting disruptions to health services caused by the coronavirus (COVID-19) pandemic (`r lnk("Fig. 3.1")`). There was a substantial recovery to `r ftb(f3.1_txt$tot_tpt_2022/1e6)` million in 2022, above the pre-pandemic level, and a further large increase in 2023 to `r ftb(f3.1_txt$tot_tpt_2023/1e6)` million. 

Since 2021 there has been a particularly noticeable increase in the number of household contacts enrolled on TPT: from `r ftb(f3.1_txt$con_tpt_2021/1e6)` million in 2021 to `r ftb(f3.1_txt$con_tpt_2023/1e6)` million in 2023. In contrast, the number of people living with HIV who were enrolled on TPT increased between 2015 and 2019 (reaching a peak of `r ftb(f3.1_txt$hiv_tpt_2019/1e6)` million in 2019) before falling in 2020 and subsequently levelling off at about 2 million people per year.


### `r anch("Fig. 3.1")`<span class="red">Fig. 3.1</span> The global number of people provided with TB preventive treatment (TPT), 2015--`r report_year - 1`

```{r fig_3.1, fig.alt="Bar chart showing numbers provided with TB preventive treatment each year since 2015"}

f3.1_plot <- f3.1_data  |>  
  
  ggplot(aes(x=year, y=how_many, fill = TPT_category)) +

  geom_bar(stat = "identity")  +

  geom_col(position = position_stack(reverse = TRUE)) +

  scale_x_continuous(name="",
                   breaks = 2015:(report_year-1)) +
  
  # display y-axis scale in millions
  scale_y_continuous(name = "Millions", 
                     labels = function(i){round(i/1e6)},
                     limits = c(0,7e6)) +

  scale_fill_manual("",
                    breaks = c("hiv_tpt", "house_con04_tpt", "house_con5plus_tpt" ),
                    labels = c("People living with HIV", "Household contacts aged <5 years", "Household contacts aged \u22655 years"),
                    values = c("hiv_tpt"="#ffc425",
                               "house_con04_tpt"="#9fcd25",
                               "house_con5plus_tpt"="#66b032")) +


  theme_gtb() +
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f3.1_plot, f3.1_data, show_static, pdf_csv_folder, save_csv, save_pdf)


```
<div id="fig_3_1"></div>

<hr />
<br />
At the second United Nations (UN) high-level meeting on TB in September 2023, a new global target for TPT coverage was set (`r ref_lnk("6")`). The target is to reach 90% coverage among people at high risk of developing TB disease by 2027; in absolute numbers, this is equivalent to providing TPT to up to approximately 45 million people globally in the 5-year period 2023--2027, including approximately 30 million household contacts of people with TB and approximately 15 million people living with HIV (see also <span class="red">Table 1</span> of the core report document). 

TPT coverage has improved globally since 2015, but remained well below the target in 2023, for both household contacts (`r ftb(f3.2_txt$e_tpt_hh_contacts_pct)`%) and people with HIV (`r ftb(f3.2_txt$c_tpt_hiv_pct)`%)  (`r lnk("Fig. 3.2")`).


### `r anch("Fig. 3.2")`<span class="red">Fig. 3.2</span> Global and regional trends in the coverage of TB preventive treatment (TPT), 2015--`r report_year - 1`

```{r fig_3.2, fig.alt="Chart showing % of household contacts and people living with HIV provided with TB preventive treatment each year since 2015 globally"}

f3.2_plot <- f3.2_data |> 
  
ggplot() +
  geom_line(aes(x=year, y=c_tpt_hiv_pct, colour = "People newly initiated on ART"), linewidth=1) +

  geom_line(aes(x=year, y=e_tpt_hh_contacts_pct, colour = "Household contacts"), linewidth=1) +
  
  geom_ribbon(
    aes(x=year, ymin = e_tpt_hh_contacts_pct_lo, ymax = e_tpt_hh_contacts_pct_hi),
    fill = "#277abe",
    alpha = 0.4
  ) +

  scale_x_continuous(name="",
                     breaks = seq(2015, report_year-1, by=2)) +
  scale_y_continuous(name = "% started on TPT") +
  
 # add target of 90% as dashed horizontal line
  geom_hline(yintercept = 90,
             linetype="dashed",
             color = "#222222",
             linewidth=1.5,
             show.legend = TRUE) +
  
  annotate("text",
           x = 2019, y = 80,
           label = "Target: 90% by 2027",
           size = 4,
           color = "#444444") +
 
  # Need a colour scale for a legend to be shown
  scale_colour_manual(name="", values = c("People newly initiated on ART" = "red",
                                          "Household contacts" = "#277abe")) +
  
  expand_limits(y = c(0, 100)) +

  facet_wrap( ~ entity, ncol = 4, scales = "free_y") +
  
  theme_gtb() +

  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f3.2_plot, f3.2_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_3_2_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_2_afr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_2_amr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_2_sear"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_2_eur"></div>
</div>
<div class="col-md-4">
<div id="fig_3_2_emr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_2_wpr"></div>
</div>
</div>

<hr />
<br />

Ensuring access to shorter rifamycin-containing regimens may help to increase access to TPT. In `r report_year - 1`, `r ftb(f3.3_txt$people_short_rfp/1e6)` million people started shorter regimens in `r f3.3_txt$countries_short_rfp` countries (`r lnk("Fig. 3.3")`). Among these `r f3.3_txt$countries_short_rfp` countries, `r f3.3_txt$tpt_3hp` countries reported using the 3-month weekly regimen of rifapentine and isoniazid (3HP) and `r f3.3_txt$tpt_1hp` reported using the 1-month daily regimen of rifapentine and isoniazid (1HP). Rifampicin-based regimens were also being used in 2023:  `r f3.3_txt$tpt_3hr` countries reported using the 3-month daily regimen of rifampicin and isoniazid (3HR) and `r f3.3_txt$tpt_4r` reported using the 4-month daily regimen of rifampicin only (4R).

### `r anch("Fig. 3.3")`<span class="red">Fig. 3.3</span> Regimens used for TB preventive treatment (TPT), by country, `r report_year -1`

#### (a) Regimens containing rifapentine (1HP and/or 3HP)^a^

```{r fig_3.3.a, fig.alt="Map showing countries using rifapentine for TB preventive treatment"}

f3.3_a_plot <- select(f3.3_data, iso3, var = rifapentine) |> 

  whomap(colours = c('#53abd0', '#d9777d'),
         legend.title = "Status",
         na.label = "No data",
         na.col = "white",
         water.col = "white")

output_ggplot(f3.3_a_plot, select(f3.3_data, iso3, var = rifapentine), show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<div class="footnote">^a^ Rifapentine products from different manufacturers are registered for use in Botswana, China, Hong Kong Special Administrative Region, the Democratic Republic of the Congo, Ethiopia, Ghana, India, Indonesia, Kenya, Malawi, Mongolia, Mozambique, Myanmar, Namibia, Nigeria, the Philippines, Rwanda, Senegal, Singapore, South Africa, Tajikistan, Thailand, Turkmenistan, Uganda, the United Republic of Tanzania, the United States of America, Zambia and Zimbabwe (source: Lupin, Macleods, Sanofi). Several countries in which rifapentine is not yet registered access it using local waiver mechanisms.</div>

#### (b) Regimens containing rifampicin (3HR and/or 4R)

```{r fig_3.3.b, fig.alt="Map showing countries using rifampicin for TB preventive treatment"}

f3.3_b_plot <- select(f3.3_data, iso3, var = rifampicin) |> 

  whomap(colours = c('#53abd0', '#d9777d'),
         legend.title = "Status",
         na.label = "No data",
         na.col = "white",
         water.col = "white")

output_ggplot(f3.3_b_plot, select(f3.3_data, iso3, var = rifampicin), show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

#### (c) Regimens containing levofloxacin (6Lfx)


```{r fig_3.3.c, fig.alt="Map showing countries using levofloxacin for TB preventive treatment"}

f3.3_c_plot <- select(f3.3_data, iso3, var = levo) |> 

  whomap(colours = c('#53abd0', '#d9777d'),
         legend.title = "Status",
         na.label = "No data",
         na.col = "white",
         water.col = "white")

output_ggplot(f3.3_c_plot, select(f3.3_data, iso3, var = levo), show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />
The newly recommended regimen of 6 months of levofloxacin (6Lfx) for contacts of people with MDR-TB was used in `r f3.3_txt$countries_used_6lfx` countries, including both high TB burden countries (`r knitr::combine_words(f3.3_txt_6lfx_hbtb30_countries$country_in_text_EN, oxford_comma=FALSE)`) and high MDR-TB burden countries (`r knitr::combine_words(f3.3_txt_6lfx_hbmdr30_countries$country_in_text_EN, oxford_comma=FALSE)`). 

## 3.2 Household contacts

Globally in `r report_year - 1`, there were an estimated `r ftb(f3.4_txt$e_hh_contacts/1e6)` million (95% uncertainty interval [UI]: `r ftb(f3.4_txt$e_hh_contacts_lo/1e6)`--`r ftb(f3.4_txt$e_hh_contacts_hi/1e6)` million) household contacts of people diagnosed with bacteriologically confirmed pulmonary TB. However, only `r ftb(f3.4_txt$newinc_con_2023/1e6)` million contacts were reported in `r report_year - 1` (up `r ftb(f3.4_txt$change_con_23_22_pct)`% from `r ftb(f3.4_txt$newinc_con_2022/1e6)` million in `r report_year - 2`); `r  ftb(f3.4_txt$newinc_con_screen_2023/1e6)` million (`r ftb(f3.4_txt$screened_pct_2023)`%) of these contacts were evaluated for both TB infection and disease (up `r ftb(f3.4_txt$change_screen_23_22_pct)`% from `r ftb(f3.4_txt$newinc_con_screen_2022/1e6)` million in `r report_year - 2`). The percentage of contacts who were evaluated varied widely among countries (`r lnk("Fig. 3.4")`). 

A total of `r ftb(f3.1_txt$con_5plus_tpt_2023/1e6)` million household contacts aged 5 years and over started TPT in `r report_year - 1`, representing a `r ftb(f3.1_txt$delta_23_22)`% increase compared with `r report_year - 2` (`r lnk("Fig. 3.1")`). `r knitr::combine_words(f3.1_txt_over5_tpt_top$country_in_text_EN, oxford_comma=FALSE)` accounted for over half of this increase.

In `r report_year - 1`, `r ftb(f3.1_txt$con04_tpt_2023/1e6)` million household contacts aged under 5 years started TPT out of an estimated `r ftb(f3.4_txt$e_prevtx_eligible/1e6)` million who were eligible -- a `r ftb(f3.1_txt$con04_23_22_pct)`% increase compared with `r report_year - 2`.

Globally, the `r ftb(f3.5_txt$con_tpt/1e6)` million household contacts provided with TPT in `r report_year - 1` represented about `r ftb(f3.5_txt$con_tpt * 100 / f3.4_txt$newinc_con_2023)`% of the `r ftb(f3.4_txt$newinc_con_2023/1e6)` million household contacts reported and `r ftb(f3.5_txt$tpt_pct)`%  of the estimated total of `r ftb(f3.4_txt$e_hh_contacts/1e6)` million household contacts. There was considerable variation among countries in both the percentage of household contacts who were evaluated for TB disease and infection, and the percentage of household contacts who were provided with TPT  (`r lnk("Fig. 3.4")`, `r lnk("Fig. 3.5")`). 


### `r anch("Fig. 3.4")`<span class="red">Fig. 3.4</span> Percentage of the reported number of household contacts of people newly diagnosed with bacteriologically confirmed pulmonary TB disease who were evaluated for TB disease and TB infection, by country, `r report_year - 1`

```{r fig_3.4, fig.alt="Map showing evaluation for TB disease and TB infection among household contacts of bacteriologically confirmed pulmonary TB cases"}

f3.4_plot <- f3.4_data |> 
  
  whomap(colours = brewer.pal(4, "Reds"),
         legend.title = "Percentage (%)",
         na.col = "white",
         water.col = "white")

output_ggplot(f3.4_plot, f3.4_data, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)


```

<hr />
<br />

### `r anch("Fig. 3.5")`<span class="red">Fig. 3.5</span> Percentage of the estimated number of household contacts of people newly diagnosed with bacteriologically confirmed pulmonary TB disease who were provided with TB preventive treatment (TPT), by country, `r report_year - 1` 


```{r fig_3.5, fig.alt="Map showing estimated percentage of household contacts given TB preventive treatment"}

f3.5_plot <- f3.5_data |> 
  
  whomap(colours = brewer.pal(3, "Greens"),
         legend.title = "Percentage (%)",
         na.col = "white",
         water.col = "white")

output_ggplot(f3.5_plot, f3.5_data, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

Data on completion of TPT among household contacts who started treatment in `r report_year - 2`  was reported by `r f3.6_txt$countries` countries; the median completion rate was `r ftb(f3.6_txt$median)`% (interquartile range [IQR], `r ftb(f3.6_txt$q1)`–`r ftb(f3.6_txt$q3)`%), but rates varied widely among WHO regions (`r lnk("Fig. 3.6")`). 


### `r anch("Fig. 3.6")`<span class="red">Fig. 3.6</span> Completion of TB preventive treatment (TPT) among household contacts, by WHO region, `r report_year - 2`
<div class="subhead">Each dot represents a country. Put cursor over a dot to see the country name.</div>


```{r fig_3.6, fig.alt="Panel plot showing percentage completion vs number contacts started TPT by WHO region"}

f3.6_plot <- f3.6_data |> 
  
  ggplot(aes(x=newinc_con_prevtx, y=pct_completed)) +
  
  geom_point(size=3, colour = "#ff748c") +
  
  scale_x_log10(name="Contacts starting TPT  (log scale)",
                     labels = function(i){gtbreport::int_spacer(i)}) +
  
  scale_y_continuous(name = "% contacts who completed TPT") +
  
  expand_limits(y = c(0, 100)) +

  facet_wrap( ~ entity, ncol = 3, scales = "free") +
  
  theme_bw() +  # Adds a panel border for Dennis

  theme_gtb() +
  
  # Get rid of x-axis line so as not to overwrite panel borders
  theme(axis.line.x = ggplot2::element_blank())

output_ggplot(f3.6_plot, f3.6_data, show_static, pdf_csv_folder, save_csv, save_pdf)


```
<div class="row">
<div class="col-md-4">
<div id="fig_3_6_afr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_6_amr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_6_sear"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_6_eur"></div>
</div>
<div class="col-md-4">
<div id="fig_3_6_emr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_6_wpr"></div>
</div>
</div>

<hr />
<br />

Globally, the cascade of TB preventive care shows a big gap between the number of household contacts screened for TB disease and the number starting TPT (`r lnk("Fig. 3.7")`).


### `r anch("Fig. 3.7")`<span class="red">Fig. 3.7</span> Cascade of care for provision of TB preventive treatment (TPT) to household contacts of people newly diagnosed with bacteriologically confirmed pulmonary TB disease, `r report_year - 2`
<div class="subhead">The graphic is limited to `r f3.7_txt$contacts_countries` countries for which data for all stages of the cascade were available.</div>
<br />


```{r fig_3.7_contacts, fig.alt="Bar chart of TPT cascade of care for household contacts (countries with data for all steps)"}

f3.7_plot <- f3.7_data |> 
  
  ggplot(aes(x=stage, y=how_many/1e6)) +
  geom_bar(stat="identity", fill="darkblue",width = 0.5) +

  ylab("Number of people (millions)") +

  xlab("") +

  theme_gtb() +

  geom_text(data=f3.7_data,
            aes(label = paste0(ftb(pct), "%") ),
            nudge_y = -0.15,
            color="white") 


output_ggplot(f3.7_plot, f3.7_data, show_static, pdf_csv_folder, save_csv, save_pdf)
 
```

<div id="fig_3_7"></div>

<hr />
<br />

## 3.3 People living with HIV

Globally, the annual number of people living with HIV who received TPT increased from fewer than 30 000 in 2005 to `r ftb(f3.8_txt$hiv_tpt_2019/1e6)` million in 2019 (`r lnk("Fig. 3.8")`). Subsequently, reported numbers fell for 3 years before stabilizing at `r ftb(f3.8_txt_reported$provided_2023/1e6)` million in 2023. Possible reasons for the reductions between 2020 and 2022 include disruptions to health services caused by the COVID-19 pandemic and changes in data collection. In a few countries, achievement of full TPT coverage among people living with HIV already on ART has also restricted new enrolments on TPT to people newly enrolled on ART. 

`r str_to_title(int2word(nrow(f3.8_txt_biggies)))` high TB/HIV burden countries, accounting for `r ftb(f3.8_txt_biggies_burden$account_for)`% of the estimated global number of people living with HIV who developed TB in `r report_year - 1`, each provided TPT to more than 100 000 people living with HIV in `r report_year - 1`, and collectively accounted for `r ftb(sum(f3.8_txt_biggies$hiv_tpt_all)/1e6)` million (`r ftb(sum(f3.8_txt_biggies$hiv_tpt_all)*100/f3.8_txt_reported$provided_2023)`%) of the global total in `r report_year - 1`: `r knitr::combine_words(f3.8_txt_biggies$country_in_text_EN, oxford_comma=FALSE)`.
 
Between 2005 (the year following the publication of the first WHO policy guidance on collaborative TB/HIV activities) and the end of `r report_year - 1`, `r ftb(f3.8_txt_cumulative$hiv_tpt_05_now/1e6)` million people living with HIV were initiated on TPT, equivalent to just under half of the 39.9 million people estimated to be living with HIV in 2023 (`r ref_lnk("7")`, `r ref_lnk("8")`).

Among `r f3.8_txt_newly_enrolled$countries` countries that reported data, a median of `r ftb(f3.8_txt_newly_enrolled$median)`% (IQR: `r ftb(f3.8_txt_newly_enrolled$q1)`–`r ftb(f3.8_txt_newly_enrolled$q3)`%) of people living with HIV who were newly started on antiretroviral therapy (ART) received TPT in `r report_year - 1`.  


### `r anch("Fig. 3.8")`<span class="red">Fig. 3.8</span> Provision of TB preventive treatment (TPT) to people living with HIV, globally and by WHO region, 2005--`r report_year - 1`

<div class="subhead">For the period 2005--2016, countries were requested to report data for people newly enrolled in HIV care (dashed <span class="red">red</span> lines). Subsequently, countries have been encouraged to report data for people currently on ART (solid <font color="blue">blue</font> lines).</div>

```{r fig_3.8, fig.alt="Panel plots showing numbers of people living with HIV provided with TB preventive treatment each year since 2005 globally and by WHO region"}

f3.8_plot <- f3.8_data |> 
  
ggplot() +
  geom_line(aes(x=year, y=hiv_tpt_new, colour = "Newly enrolled on HIV treatment"), linewidth=1, linetype="dashed") +

  geom_line(aes(x=year, y=hiv_tpt_all, colour = "Currently on HIV treatment"), linewidth=1, linetype="solid") +

  scale_x_continuous(name="",
                     breaks = c(2005, 2010, 2015, report_year-1)) +
  scale_y_continuous(name = "Number of people (thousands)",
                     # Use the remainder operator in the labeller function to make sure we don't get weird effects
                     # when plotting small numbers
                     labels = function(i){ifelse((i/1e3) %% 1 == 0, gtbreport::int_spacer(i/1e3), "")}) +
  
  # Need a colour scale for a legend to be shown
  scale_colour_manual(name="", values = c("Newly enrolled on HIV treatment" = "red",
                                          "Currently on HIV treatment" = "#277abe")) +
  
  expand_limits(y = 0) +

  facet_wrap( ~ entity, ncol = 4, scales = "free_y") +

  theme_gtb() +

  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f3.8_plot, f3.8_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_3_8_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_8_afr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_8_amr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_8_sear"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_8_eur"></div>
</div>
<div class="col-md-4">
<div id="fig_3_8_emr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_8_wpr"></div>
</div>
</div>



<hr />
<br />


In `r f3.9_txt$countries` countries that reported data, a median of `r ftb(f3.9_txt$median)`% (IQR: `r ftb(f3.9_txt$q1)`–`r ftb(f3.9_txt$q3)`%) of people living with HIV who started TPT in `r report_year - 2` completed their treatment (`r lnk("Fig. 3.9")`). 

### `r anch("Fig. 3.9")`<span class="red">Fig. 3.9</span> Completion of TB preventive treatment (TPT) among people living with HIV, by WHO region, `r report_year - 2`
<div class="subhead">Each dot represents a country. Put cursor over a dot to see the country name.</div>


```{r fig_3.9, fig.alt="Dot plot showing percentage completion vs number PLHIV started TPT coloured by WHO region"}

f3.9_plot <- f3.9_data |> 
  
  ggplot(aes(x=hiv_all_tpt_started, y=pct_completed)) +
  
  geom_point(size=3, colour = "#ff748c") +
  
  scale_x_log10(name="People living with HIV starting TPT (log scale)",
                     labels = function(i){gtbreport::int_spacer(i)}) +
  
  scale_y_continuous(name = "% who completed TPT") +
  
  scale_color_hue(name = '') + 
  
  expand_limits(y = c(0, 100)) +

  facet_wrap( ~ entity, ncol = 3, scales = "free") +
  
  theme_bw() +  # Adds a panel border for Dennis

  theme_gtb() +
  
  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())

output_ggplot(f3.9_plot, f3.9_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div class="row">
<div class="col-md-4">
<div id="fig_3_9_afr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_9_amr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_9_sear"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_9_eur"></div>
</div>
<div class="col-md-4">
<div id="fig_3_9_emr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_9_wpr"></div>
</div>
</div>

<hr />
<br />

## 3.4 Screening for TB disease in household contacts and other high-risk groups 

Among `r f3.10_txt$countries` countries that reported the results of TB screening in household contacts in `r report_year -1`, the overall yield of people with TB was `r ftb(f3.10_txt$overall)`% (median: `r ftb(f3.10_txt$median)`%; IQR: `r ftb(f3.10_txt$q1)`–`r ftb(f3.10_txt$q3)`%) (`r lnk("Fig. 3.10")`). This is slightly lower than what would be expected in household contacts of people with bacteriologically confirmed TB (`r ref_lnk("9")`). The wide variation among countries probably reflects differences in the coverage of screening for eligible individuals, the diagnostic algorithms being used and the completeness of reporting. 


### `r anch("Fig. 3.10")`<span class="red">Fig. 3.10</span> Percentage of household contacts diagnosed with TB disease among those screened, by WHO region, `r report_year - 1`
<div class="subhead">Each dot represents a country. Put cursor over a dot to see the country name. The shaded line indicates the confidence interval of estimates of TB prevalence among contacts of people with bacteriologically confirmed TB (`r ref_lnk("9")`).</div>

```{r fig_3.10, fig.alt="Panel plot showing percentage household contacts with TB disease among those screened by WHO region"}

f3.10_plot <- f3.10_data |> 
  
  ggplot(aes(x=newinc_con_screen, y=pct_tb)) +
  
  geom_point(size=3, colour = "#ff748c") +
  
  scale_x_log10(name="Contacts screened for TB (log scale)",
                     labels = function(i){gtbreport::int_spacer(i)}) +
  
  scale_y_log10(name = "% contacts with TB  (log scale)",
                     labels = function(i){gtbreport::ftb(i)}) +
  
  expand_limits(y = c(0, 100)) +
  
  # Add a shaded box to highlight the expected yield
  annotate("rect", xmin = 1, xmax = max(f3.10_data$newinc_con_screen)*1.1, ymin = 3.3, ymax = 4,
           colour = "#EEEEEE", alpha = 0.2) +

  annotate('text', x = 5, y = 6, label = '3.3% – 4.0%', size = 3) +
  
  geom_hline(yintercept=3.3, linetype="dashed", color = "red") +
  geom_hline(yintercept=4, linetype="dashed", color = "red") +


  facet_wrap( ~ entity, ncol = 3) +
  
  theme_bw() +  # Adds a panel border for Dennis

  theme_gtb() +
  
  # remove legend caused by the ribbon fill
  theme(legend.position="none") +
  
  # Get rid of x-axis line so as not to overwrite panel borders
  theme(axis.line.x = ggplot2::element_blank())

output_ggplot(f3.10_plot, f3.10_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div class="row">
<div class="col-md-4">
<div id="fig_3_10_afr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_10_amr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_10_sear"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_10_eur"></div>
</div>
<div class="col-md-4">
<div id="fig_3_10_emr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_10_wpr"></div>
</div>
</div>

<hr />
<br />

In `r report_year - 1`, `r nrow(filter(f3.11_data, !is.na(pct_screen)))` countries reported the number of people newly diagnosed with TB who were identified through provider-initiated screening efforts in high-risk groups such as contacts, people living with HIV, people in prisons and mining communities, and through facility-based screening of people with diabetes and other groups  (`r lnk("Fig. 3.11")`).

In `r report_year - 1`, `r f3.11_cxr_coverage$countries` out of `r f3.11_txt_cxr_asked` priority countries reported data about the availability of chest radiography for regular TB screening or active TB case-finding campaigns. Of those `r f3.11_cxr_coverage$countries` countries, `r f3.11_txt_cxr_75pct` (`r ftb(f3.11_txt_cxr_75pct * 100 / f3.11_cxr_coverage$countries)`%)  reported the regular use of chest radiography -- with or without computer-aided detection software -- in 75% or more of administrative units in the country (median coverage for `r f3.11_cxr_coverage$countries` countries: `r ftb(f3.11_cxr_coverage$median)`% of administrative units, IQR: `r ftb(f3.11_cxr_coverage$q1)`--`r ftb(f3.11_cxr_coverage$q3)`%).

### `r anch("Fig. 3.11")`<span class="red">Fig. 3.11</span> Percentage of people newly diagnosed with TB (new and relapse cases) reported through TB screening efforts, `r report_year - 1`

```{r fig_3.11, fig.alt="Map showing percentage of new and relapse cases reported through TB screening efforts"}

f3.11_plot <- f3.11_data |> 
  
  whomap(colours = brewer.pal(4, "Greens"), 
         legend.title = "Percentage (%)",
         na.col = "white",
         water.col = "white",
         legend.pos = c(0.08, 0.26))

output_ggplot(f3.11_plot, f3.11_data, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

## 3.5 Tests for TB infection

Tests for TB infection can help to target TPT to people who can gain the most benefit from it. In `r report_year - 1`, `r f3.12_data |> filter(var %in% c("Tuberculin Skin Tests (TST) only", "Interferon Gamma Release Assays (IGRA) +/- TST")) |> nrow()` countries reported using tuberculin skin tests (TST) or interferon gamma release assays (IGRA) in either the public or private sectors to deliver TPT to populations at risk (`r lnk("Fig. 3.12")`).  A further `r f3.12_data |> filter(var=="Antigen-based Skin Tests (TBST) +/-TST +/-IGRA") |> nrow()` countries reported using antigen-based skin tests in addition to IGRA or TST. Of the `r f3.12_data |> filter(var=="Not used") |> nrow()` countries reporting no use of tests for TB infection, `r f3.12_data |> filter(var=="Not used" & g_whoregion == 'AFR') |> nrow()` were in the WHO African Region.

### `r anch("Fig. 3.12")`<span class="red">Fig. 3.12</span> Diagnostic tests used for TB infection, by country, `r report_year - 1`

```{r fig_3.12, fig.alt="Map showing diagnostic tests in use for TB infection"}

f3.12_plot <- f3.12_data |> 
  
  whomap(colours = c("#40bf73", "#008dc9", "#bd53bd", "#f4a81d"), 
         legend.title = "Diagnostic tests used",
         na.col = "white",
         water.col = "white",
         legend.pos = c(0.08, 0.26))

output_ggplot(f3.12_plot, f3.12_data, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

## 3.6 TB infection prevention and control

The risk of TB among health care workers relative to the risk in the general adult population is one of the indicators that WHO recommends for measuring the impact of TB infection prevention and control interventions in health care facilities. If effective prevention measures are in place, the risk ratio for TB in health care workers compared with the general adult population should be close to 1. 

In `r report_year - 1`, `r int_spacer(f3.13_txt$tot_hcw_tb)` health care workers from `r f3.13_txt$countries_hcw_tb` countries were reported to have been diagnosed with TB. The ratio of the TB notification rate among health care workers to the general adult population was greater than 1 in `r f3.13_txt$countries_nrr` countries that reported five or more health care workers diagnosed with TB (`r lnk("Fig. 3.13")`).

### `r anch("Fig. 3.13")`<span class="red">Fig. 3.13</span> Notification rate ratio of TB among health care workers compared with the adult population, by country, `r report_year - 1`

```{r fig_3.13, fig.alt="Map showing ratio of TB notification rates among health care workers to those among the adult population"}

f3.13_plot <- f3.13_data |> 
  
  whomap(colours = rev(brewer.pal(4, "Spectral")),
         legend.title = "Notification rate ratio",
         na.col = "white",
         water.col = "white")

output_ggplot(f3.13_plot, f3.13_data, show_static=TRUE, pdf_csv_folder, save_csv, save_pdf)

```

<hr />
<br />

## 3.7 Bacille Calmette-Guérin vaccination

Bacille Calmette-Guérin (BCG) vaccination is recommended as part of national childhood immunization programmes, in line with a country’s TB epidemiology (`r ref_lnk("10")`). However, global coverage dropped from `r f3.14_txt$bcg_cov_2019`% in 2019 to `r f3.14_txt$bcg_cov_2020`% in 2020 and `r f3.14_txt$bcg_cov_2021`% in 2021, probably due to disruptions to health services caused by the COVID-19 pandemic. There was a recovery back to `r f3.14_txt$bcg_cov_2022`%  in 2022 and `r f3.14_txt$bcg_cov_2023`%  in 2023 (`r lnk("Fig. 3.14")`) (`r ref_lnk("11")`).


### `r anch("Fig. 3.14")`<span class="red">Fig. 3.14</span> BCG vaccination coverage in infants,^a^ globally and by WHO region 2015--`r report_year - 1`

```{r fig_3.14, fig.alt="Panel plot showing BCG immunisation coverage globally and by WHO regions annually since 2015"}

f3.14_plot <- f3.14_data |> 

  ggplot(aes(x=year, y=bcg_coverage)) +

  # # Add shaded box to highlight the covid years
  # annotate("rect", xmin = 2019.5, xmax = 2021.5, ymin = 60, ymax = 100, 
  #          colour = "#EEEEEE", alpha = 0.1) +
  
  geom_line(size = 1.5, colour = "slateblue4") +

  scale_x_continuous(name="",
                     breaks = seq(from=2015, to=report_year-1, by=2)) +
  scale_y_continuous(name = "BCG coverage (%)") +

  expand_limits(y = 60) +
  

  facet_wrap( ~ entity, ncol = 4) +

  theme_gtb() +

  # Get rid of annoying x-axis line and ticks
  theme(axis.line.x = ggplot2::element_blank(),
        axis.ticks.x = element_blank())


output_ggplot(f3.14_plot, f3.14_data, show_static, pdf_csv_folder, save_csv, save_pdf)

```
<div id="fig_3_14_global"></div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_14_afr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_14_amr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_14_sear"></div>
</div>
</div>

<div class="row">
<div class="col-md-4">
<div id="fig_3_14_eur"></div>
</div>
<div class="col-md-4">
<div id="fig_3_14_emr"></div>
</div>
<div class="col-md-4">
<div id="fig_3_14_wpr"></div>
</div>
</div>

<div class="footnote">^a^ Data for `r report_year - 1` were reported by `r f3.14_txt_rep_glob$rep` out of `r f3.14_txt_rep_glob$all` WHO Member States (`r filter(f3.14_txt_rep_reg, g_whoregion=="AFR")["rep"]`/`r filter(f3.14_txt_rep_reg, g_whoregion=="AFR")["all"]` in the WHO African Region, `r filter(f3.14_txt_rep_reg, g_whoregion=="AMR")["rep"]`/`r filter(f3.14_txt_rep_reg, g_whoregion=="AMR")["all"]` in the Region of the Americas, `r filter(f3.14_txt_rep_reg, g_whoregion=="SEA")["rep"]`/`r filter(f3.14_txt_rep_reg, g_whoregion=="SEA")["all"]` in the South-East Asia Region, `r filter(f3.14_txt_rep_reg, g_whoregion=="EUR")["rep"]`/`r filter(f3.14_txt_rep_reg, g_whoregion=="EUR")["all"]` in the European Region, `r filter(f3.14_txt_rep_reg, g_whoregion=="EMR")["rep"]`/`r filter(f3.14_txt_rep_reg, g_whoregion=="EMR")["all"]` in the Eastern Mediterranean Region and `r filter(f3.14_txt_rep_reg, g_whoregion=="WPR")["rep"]`/`r filter(f3.14_txt_rep_reg, g_whoregion=="WPR")["all"]` in the Western Pacific Region).</div>


`r anch("refs")`

<hr style="border:1px solid gray20">

**References**

1. The End TB strategy. Geneva: World Health Organization; 2015 (https://iris.who.int/handle/10665/331326).

2. WHA67.1: Global strategy and targets for tuberculosis prevention, care and control after 2015. Geneva: World Health Organization; 2014 (https://apps.who.int/gb/ebwha/pdf_files/WHA67-REC1/A67_2014_REC1-en.pdf#page=25).

3. WHO consolidated guidelines on tuberculosis. Module 1: Prevention – Tuberculosis preventive treatment, second edition. Geneva: World Health Organization; 2024 (https://iris.who.int/handle/10665/378536).

4. WHO consolidated guidelines on tuberculosis. Module 2: Screening – Systematic screening for tuberculosis disease. Geneva: World Health Organization; 2021 (https://iris.who.int/handle/10665/340255).

5. WHO guidelines on tuberculosis infection prevention and control. 2019 update. Geneva: World Health Organization; 2019. (https://iris.who.int/handle/10665/311259).

6.	Resolution 78/5: Political declaration of the high-level meeting of the General Assembly on the fight against tuberculosis. New York: United Nations; 2023 (https://undocs.org/A/RES/78/5).

7. UNAIDS epidemiological estimates, 2023 (https://aidsinfo.unaids.org/).

8. Interim policy collaborative TB/HIV activities. Geneva: World Health Organization; 2004 (https://iris.who.int/handle/10665/78705)

9. Fox GJ, Barry SE, Britton WJ, Marks GB. Contact investigation for tuberculosis: a systematic review and meta-analysis. European Respiratory Journal. 2013 Jan 1;41(1):140–56. (https://erj.ersjournals.com/content/41/1/140).

10. Weekly Epidemiological Record, 2018, vol. 93, 08, 73 - 96. Geneva: World Health Organization; 2018. (https://iris.who.int/handle/10665/260306).

11. The WHO Global Health Observatory (https://www.who.int/data/gho/data/indicators/indicator-details/GHO/bcg-immunization-coverage-among-1-year-olds-(-)). Data downloaded `r attr(f3.14_data, which = "timestamp") |> format("%d %B %Y")`.


```{r js_functions}
# Insert javascript file containing common Kendo number formatting functions ----
cat(writeLines(readLines(here("report/resources/gtbr_js.htm")))) 
```

<script type="text/javascript">

/* JSON data objects for the figures */

var fig_3_1_data = `r f3.1_data |> pivot_wider(names_from = "TPT_category", id_cols = "year", values_from = "how_many") |> toJSON("rows")`;

var fig_3_2_data = `r f3.2_data |> toJSON("rows")`;

var fig_3_6_data = `r f3.6_data |> mutate(size=10) |>  select(-newinc_con_prevtx_cmplt) |> toJSON("rows")`;

var fig_3_7_data = `r f3.7_data |> toJSON("rows")`;

var fig_3_8_data = `r f3.8_data |> toJSON("rows")`;

var fig_3_9_data = `r f3.9_data |> mutate(size=10) |>  select(-hiv_all_tpt_completed) |> toJSON("rows")`;

var fig_3_10_data = `r f3.10_data |> mutate(size=10) |>  select(-newinc_con_tb) |> toJSON("rows")`;

var fig_3_14_data = `r f3.14_data |> arrange(entity, year) |> toJSON("rows")`;

</script>


```{js, echo=FALSE}

/* Functions to create the figures */

function createFig_3_1() {
        $("#fig_3_1").kendoChart({
            dataSource: {
                data: fig_3_1_data
            },
            legend: {
                position: "bottom"
            },
            seriesDefaults: {
                type: "column",
                stack: true,
                gap: 0.2,
                tooltip: {
                    visible: true,
                    template: "#= series.name #: (#= category #): #= num_spacer(value)#"
                }
            },
            series: [{
                name: "People living with HIV",
                field: "hiv_tpt",
                color: "#ffc425"
                }, {
                name: "Household contacts aged <5 years",
                field: "house_con04_tpt",
                color: "#9fcd25"
                }, {
                name: "Household contacts aged \u22655 years",
                field: "house_con5plus_tpt",
                color: "#66b032"
            }],
            valueAxis: {
                labels: {
                    template: "#= kendo.format('{0}',value/1000000) #"
                },
                title: {
                    text: "Number of people (millions)"
                },
                line: {
                    visible: false
                }
            },
            categoryAxis: {
                field: "year",
                labels: {
                    rotation: "auto"
                },
                majorGridLines: {
                    visible: false
                }
            }
        });
}

function createFig_3_2(fig_ID, data, filter, showLegend) {
 
  // Filter the dataset on the entity variable
  dataJSON = data.filter( element => element.entity == filter);

  $(fig_ID).kendoChart({
      dataSource: dataJSON,
      chartArea: {
          height: 250
      },  
      title: {
                text: filter,
                color: "black",
                font: "bold 14px  Arial,Helvetica,sans-serif"
            },  
      legend: {
          visible: showLegend,
          position: "bottom"
      },
      series: [{
                type: "line",
        name: "People newly initated on ART",
                field: "c_tpt_hiv_pct",
                color: "red",
                tooltip: {
                    visible: true,
                    template: "People newly initated on ART (#= category #): #= value.toPrecision(2) #%"
                }
            },{
                type: "line",
        name: "Household contacts",
                field: "e_tpt_hh_contacts_pct",
                color: "#277abe",
                tooltip: {
                    visible: true,
                    template: "Household contacts (#= category #): #= value.toPrecision(2) #%"
                }
            },{
                type: "rangeArea",
                fromField: "e_tpt_hh_contacts_pct_lo",
                toField: "e_tpt_hh_contacts_pct_hi",
                color: "#277abe",
                tooltip: {
                    visible: true,
                format: "{0}",
                template: "95% uncertainty interval (#= category #): #= value.from.toPrecision(2) #\u2013#= value.to.toPrecision(2) #%"
                }
            },{
              // Use a data field to create a dashed horizontal line for the 90% target instead of a valueAxis.plotBands object which doesn't look as nice
              // but retain the plotBands object as it has ice labelling properties
              type: "line",
              dashType: "dash",
              field: "unhlm_target",
              color: "#444444",
              markers: {
                   size: 0,
                   opacity: 0
                 },
                  tooltip: {
                      visible: false,
                  }
            }],      
            valueAxis: {
                labels: {
                            template: "#= kendo.format('{0}', value) #"
                        },
                        title: {
                            text: "% started on TPT",
                            visible: true
                        },
                min: 0,
                max: 100,
                line: {
                    visible: false
                },
            		plotBands: [{
            			from: 89.9,
            			to: 90.1,
            			color: "#444444",
            			// make the bands invisible, but keep the label visible
            			opacity: 0,
            			label: {
            				text: "Target: 90% by 2027",
            				font: "12px Arial,Helvetica,sans-serif",
            				color: "#444444",
            				position: "top",
            				align: "center",
            				padding: -20
            			}
            		}]
            },
            categoryAxis: {
                field: "year",
                labels: {
                    rotation: "auto",
                    step: 2
                },
                majorGridLines: {
                    visible: false
                },
                title: {
                    text: "Year",
                    visible: true
                }
            }

        });
}


function createFig_3_6_3_9(fig_ID, data, filter, tpt_start_field_name) {

  // Filter the dataset on the entity variable
  dataJSON = data.filter( element => element.entity == filter);

  $(fig_ID).kendoChart({
        dataSource: dataJSON,
        chartArea: {
            height: 250
        },  
        title: {
                  text: filter,
                  color: "black",
                  font: "bold 14px  Arial,Helvetica,sans-serif"
              },  
        legend: {
            // hide the legend
            visible: false
        },
        series: [{
        // Using bubble instead of scatter chart otherwise wouldn't be able to see 
        // the country name in the tooltip. So had to fix a bubble size in the data
        type: "bubble",
        xField: tpt_start_field_name,
        yField: "pct_completed",
        categoryField: "country",
        sizeField: "size",
        maxSize: 10,
        minSize: 10,
            }],
        yAxis: {
            labels: {
                template: "#= kendo.format('{0}', value) #"
            },
            title: {
                text: "% contacts who completed TPT",
                visible: true,
                font: "12px  Arial,Helvetica,sans-serif"
            },
            line: {
                visible: false
            }
        },
        xAxis: {
            type: "log",
            min: 1.0,
            majorGridLines: {
                visible: false
            },
            labels: {
                template: "#= kendo.format('{0}',axis_spacer(value)) #",
                step: 2
            },
            title: {
                text: "Contacts starting TPT\n(log scale)",
                visible: true,
                font: "12px  Arial,Helvetica,sans-serif"
            }
        },
        tooltip: {
				    visible: true,
				    template: "#= category #, #= num_spacer(value.x)# started treatment, #= tb_format_pct(value.y)#% completed"
			}
    });
}




function createFig_3_7() {
        $("#fig_3_7").kendoChart({
            dataSource: {
                data: fig_3_7_data
            },
            legend: {
              // hide the legend
              visible: false
            },
            seriesDefaults: {
                type: "column",
                gap: 0.2,
                tooltip: {
                    visible: true,
                    template: "#= category #: #= num_spacer(value)#"
                }
            },
            series: [{
                name: "Number of people",
                field: "how_many",
                color: "#00008B"
                }],
            valueAxis: {
                labels: {
                    template: "#= kendo.format('{0}',value/1000000) #"
                },
                title: {
                    text: "Number of people (millions)"
                },
                line: {
                    visible: false
                }
            },
            categoryAxis: {
                field: "stage",
                labels: {
                    rotation: "auto"
                },
                majorGridLines: {
                    visible: false
                }
            }
        });
}


function createFig_3_8(fig_ID, data, filter) {

  // Filter the dataset on the entity variable
  dataJSON = data.filter( element => element.entity == filter);

  $(fig_ID).kendoChart({
        dataSource: dataJSON,
        chartArea: {
            height: 250
        },  
        title: {
                  text: filter,
                  color: "black",
                  font: "bold 14px  Arial,Helvetica,sans-serif"
              },  
        legend: {
            // hide the legend
            visible: false
        },
        seriesDefaults: {
            type: "line",
            tooltip: {
                visible: true,
                template: "#= series.name #: (#= category #): #= num_spacer(value)#"
            }
        },
        series: [{
            name: "Newly enrolled on HIV treatment",
            field: "hiv_tpt_new",
            color: "red",
    				dashType: "dash",
            markers: {
              size: 3
            }
            },{
            name: "Currently on HIV treatment",
            field: "hiv_tpt_all",
            color: "blue",  
            markers: {
              size: 3
            }
            }],
        valueAxis: {
            labels: {
                template: "#= axis_spacer(value/1e3) #"
            },
            title: {
                text: "Number of people (thousands)",
                visible: true,
                font: "12px  Arial,Helvetica,sans-serif"
            },
            line: {
                visible: false
            }
        },
        categoryAxis: {
            field: "year",
            labels: {
                step: 5
            },
            majorGridLines: {
                visible: false
            },
            title: {
                text: "Year",
                visible: true,
                font: "12px  Arial,Helvetica,sans-serif"
            }
        }
    });
}



function createfig_3_10(fig_ID, data, filter) {

  // Filter the dataset on the entity variable
  dataJSON = data.filter( element => element.entity == filter);

  $(fig_ID).kendoChart({
        dataSource: dataJSON,
        chartArea: {
            height: 250
        },  
        title: {
                  text: filter,
                  color: "black",
                  font: "bold 14px  Arial,Helvetica,sans-serif"
              },  
        legend: {
            // hide the legend
            visible: false
        },
        series: [{
        // Using bubble instead of scatter chart otherwise wouldn't be able to see 
        // the country name in the tooltip. So had to fix a bubble size in the data
        type: "bubble",
        xField: "newinc_con_screen",
        yField: "pct_tb",
        categoryField: "country",
        sizeField: "size",
        maxSize: 10,
        minSize: 10,
            }],
        yAxis: {
            type: "log",
            min: 0.01,
			      max: 150,
			      axisCrossingValue: 0.01,
            labels: {
                template: "#= kendo.format('{0}', value) #"
            },
            title: {
                text: "% contacts with TB\n(log scale)",
                visible: true,
                font: "12px  Arial,Helvetica,sans-serif"
            },
            line: {
                visible: false
            },
            // Add horizontal line at between 3.3 and 4%
        plotBands: [{ 
            from: 3.3, 
    				to: 4, 
    				color: "#999999", 
    				opacity: 0.5,
    				label: {
    				    text: "3.3% – 4.0%", 
    				    position: "top", 
    				    color: "#999999",
    				    padding: {top:-16, left:5} 
    				} 
			    }]
        },
        xAxis: {
            type: "log",
            majorGridLines: {
                visible: false
            },
            labels: {
                template: "#= kendo.format('{0}',axis_spacer(value)) #",
                step: 2
            },
            title: {
                text: "Contacts screened for TB\n(log scale)",
                visible: true,
                font: "12px  Arial,Helvetica,sans-serif"
            }
        },
        tooltip: {
				    visible: true,
				    template: "#= category #, #= num_spacer(value.x)# screened, #= tb_format_pct(value.y)#% with TB"
			}
    });
}


function createFig_3_14(fig_ID, data, filter) {
  
  		// Filter the dataset on the country variable
		dataJSON = data.filter( element => element.entity == filter);
  
		$(fig_ID).kendoChart({
			dataSource: dataJSON,
			chartArea: {
				height: 250
			},	
      title: {
				text: filter,
				color: "black",
				font: "bold 14px  Arial,Helvetica,sans-serif",
        align: "center"
			},	
			legend: {
				position: "bottom"
			},
			seriesDefaults: {
				type: "line"
			},
			series: [{
				field: "bcg_coverage",
				color: "#473c8b", 
        markers: {
          size: 3
        },
        tooltip: {
				visible: true,
				template: "#= category #: #= value.toPrecision(2) #%",
			}
			}],
			valueAxis: {
				labels: {
					format: "{0}"
				},
				title: {
					text: "BCG coverage (%)",
          font: "14px Arial,Helvetica,sans-serif"
				},
				line: {
					visible: false
				},
        max: 100,
        min: 60
			},
			categoryAxis: {
				field: "year",
        labels: {
					rotation: "auto",
					step: 2
          },
				majorGridLines: {
					visible: false
				},
				title: {
					text: "Year"
				}
			}

		});
}


```


```{js, echo=FALSE}

/* Create the figures after the document has been loaded */

$(document).ready(function() {
  
  createFig_3_1();
  
  createFig_3_2("#fig_3_2_global", fig_3_2_data, "Global", true)
  createFig_3_2("#fig_3_2_afr", fig_3_2_data, "African Region", false);
  createFig_3_2("#fig_3_2_amr", fig_3_2_data, "Region of the Americas", false);
  createFig_3_2("#fig_3_2_sear", fig_3_2_data, "South-East Asia Region", false);
  createFig_3_2("#fig_3_2_eur", fig_3_2_data, "European Region", false);
  createFig_3_2("#fig_3_2_emr", fig_3_2_data, "Eastern Mediterranean Region", false);
  createFig_3_2("#fig_3_2_wpr", fig_3_2_data, "Western Pacific Region", false);
  
  createFig_3_7();

  createFig_3_6_3_9("#fig_3_6_afr", fig_3_6_data, "African Region", "newinc_con_prevtx");
  createFig_3_6_3_9("#fig_3_6_amr", fig_3_6_data, "Region of the Americas", "newinc_con_prevtx");
  createFig_3_6_3_9("#fig_3_6_sear", fig_3_6_data, "South-East Asia Region", "newinc_con_prevtx");
  createFig_3_6_3_9("#fig_3_6_eur", fig_3_6_data, "European Region", "newinc_con_prevtx");
  createFig_3_6_3_9("#fig_3_6_emr", fig_3_6_data, "Eastern Mediterranean Region", "newinc_con_prevtx");
  createFig_3_6_3_9("#fig_3_6_wpr", fig_3_6_data, "Western Pacific Region", "newinc_con_prevtx");
  
  
  createFig_3_8("#fig_3_8_global", fig_3_8_data, "Global");
  createFig_3_8("#fig_3_8_afr", fig_3_8_data, "African Region");
  createFig_3_8("#fig_3_8_amr", fig_3_8_data, "Region of the Americas");
  createFig_3_8("#fig_3_8_sear", fig_3_8_data, "South-East Asia Region");
  createFig_3_8("#fig_3_8_eur", fig_3_8_data, "European Region");
  createFig_3_8("#fig_3_8_emr", fig_3_8_data, "Eastern Mediterranean Region");
  createFig_3_8("#fig_3_8_wpr", fig_3_8_data, "Western Pacific Region");
  
  createFig_3_6_3_9("#fig_3_9_afr", fig_3_9_data, "African Region", "hiv_all_tpt_started");
  createFig_3_6_3_9("#fig_3_9_amr", fig_3_9_data, "Region of the Americas", "hiv_all_tpt_started");
  createFig_3_6_3_9("#fig_3_9_sear", fig_3_9_data, "South-East Asia Region", "hiv_all_tpt_started");
  createFig_3_6_3_9("#fig_3_9_eur", fig_3_9_data, "European Region", "hiv_all_tpt_started");
  createFig_3_6_3_9("#fig_3_9_emr", fig_3_9_data, "Eastern Mediterranean Region", "hiv_all_tpt_started");
  createFig_3_6_3_9("#fig_3_9_wpr", fig_3_9_data, "Western Pacific Region", "hiv_all_tpt_started");

  createfig_3_10("#fig_3_10_afr", fig_3_10_data, "African Region");
  createfig_3_10("#fig_3_10_amr", fig_3_10_data, "Region of the Americas");
  createfig_3_10("#fig_3_10_sear", fig_3_10_data, "South-East Asia Region");
  createfig_3_10("#fig_3_10_eur", fig_3_10_data, "European Region");
  createfig_3_10("#fig_3_10_emr", fig_3_10_data, "Eastern Mediterranean Region");
  createfig_3_10("#fig_3_10_wpr", fig_3_10_data, "Western Pacific Region");
  
  createFig_3_14("#fig_3_14_global", fig_3_14_data, "Global");
  createFig_3_14("#fig_3_14_afr", fig_3_14_data, "African Region");
  createFig_3_14("#fig_3_14_amr", fig_3_14_data, "Region of the Americas");
  createFig_3_14("#fig_3_14_sear", fig_3_14_data, "South-East Asia Region");
  createFig_3_14("#fig_3_14_eur", fig_3_14_data, "European Region");
  createFig_3_14("#fig_3_14_emr", fig_3_14_data, "Eastern Mediterranean Region");
  createFig_3_14("#fig_3_14_wpr", fig_3_14_data, "Western Pacific Region");

});

```



